//================================================================================ 
// SuperMap IS .NET 客户端程序，版权所有，北京超图软件股份有限公司，2000-2008。 
// 本程序只能在有效的授权许可下使用。未经许可，不得以任何手段擅自使用或传播。 
// 作 者:  SuperMap IS Web Team 
// 版 本:  $Id: SuperMap.IS.LegendControl.js,v 1.60.2.10 2009/10/16 09:36:51 zhangyt Exp $
// 文 件:  SuperMap.IS.LegendControl.js 
// 描 述:  AjaxScripts 图例控件 
// 更 新:  $Date: 2009/10/16 09:36:51 $ 
//================================================================================ 
SuperMap.IS.LegendControl=function(container,map,param){var _map=null;var _layers=null;var _id=container.id;var _inited=false;var _imageFormat=1;var _isNeedTitle=false;if(param&&typeof (param.isNeedTitle)!="undefined"){_isNeedTitle=param.isNeedTitle}var _isShowInCurrentPage=true;if(param&&typeof (param.isShowInCurrentPage)!="undefined"){_isShowInCurrentPage=param.isShowInCurrentPage}var _legendUrl="";if(param&&typeof (param.legendUrl)!="undefined"){_legendUrl=param.legendUrl}var _eventsList=new Array();var _eventsNameList=new Array();var _indexs;var _headerBackColor="White";if(param&&typeof (param.headerBackColor)!="undefined"){_headerBackColor=param.headerBackColor}this.titleFont=new SuperMap.IS.Font();if(param&&typeof (param.titleFont)!="undefined"){var titleFont=_eval("("+param.titleFont+")");this.titleFont.FromJSON(titleFont);titleFont=null}var _headerForeColor="Black";if(param&&typeof (param.headerForeColor)!="undefined"){_headerForeColor=param.headerForeColor}var _itemBackColor="White";if(param&&typeof (param.itemBackColor)!="undefined"){_itemBackColor=param.itemBackColor}this.itemFont=new SuperMap.IS.Font();if(param&&typeof (param.itemFont)!="undefined"){var itemFont=_eval("("+param.itemFont+")");this.itemFont.FromJSON(itemFont);itemFont=null}var _itemForeColor="Black";if(param&&typeof (param.itemForeColor)!="undefined"){_itemForeColor=param.itemForeColor}this.separator="@";if(param&&typeof (param.separator)!="undefined"){this.separator=param.separator}this.overFlowEnabled=true;if(param&&typeof (param.overFlowEnabled)!="undefined"){this.overFlowEnabled=param.overFlowEnabled}this.expand=false;if(param&&typeof (param.expand)!="undefined"){this.expand=param.expand}var _resourceWidth=16;if(param&&param.resourceWidth){_resourceWidth=param.resourceWidth}var _resourceHeight=16;if(param&&param.resourceHeight){_resourceHeight=param.resourceHeight}var _themeNameEnabled=true;if(param&&param.themeNameEnabled){_themeNameEnabled=param.themeNameEnabled}var _self=this;var _containerInside=null;var _lastLayers=null;this.Destroy=_Destroy;this.Update=_Update;if(map){map.AttachEvent("oninit",_Init);map.AttachEvent("ondestroying",_Destroy)}function _Init(){if(_inited){return }if(_containerInside){if(_containerInside.parentNode){_containerInside.parentNode.removeChild(_containerInside)}_containerInside=null}_containerInside=document.createElement("div");var heightUnit="px";var widthUnit="px";var width=container.style.pixelWidth;if(param&&typeof (param.width)!="undefined"){widthUnit=_GetUnit(param.width);width=param.width.toString().replace(widthUnit,"")}var height=container.style.pixelHeight;if(param&&typeof (param.height)!="undefined"){heightUnit=_GetUnit(param.height);height=param.height.toString().replace(heightUnit,"")}_containerInside.style.width=width+widthUnit;_containerInside.style.height=height+heightUnit;_containerInside.style.position="relative";container.appendChild(_containerInside);if(_self.overFlowEnabled){_containerInside.style.overflow="auto";_containerInside.style.overflowX="auto";_containerInside.style.overflowY="auto"}_inited=true;_map=map;_layers=map.layers;_InitIndexs();if(_isShowInCurrentPage){_RenderLayers()}else{container.style.visibility="hidden"}if(map){map.AttachEvent("onendswitchmap",_Update);map.AttachEvent("onchangelayer",_Update)}}function _GetUnit(value){if(value.toString().indexOf("px")!=-1){return"px"}else{if(value.toString().indexOf("%")!=-1){return"%"}}return"px"}function _Destroy(){if(_map){map.DetachEvent("onendswitchmap",_Update);map.DetachEvent("onchangelayer",_Update);map.DetachEvent("oninit",_Init);map.DetachEvent("ondestroying",_Destroy)}if(_layers){while(_layers.length>0){var layer=_layers.pop();layer.Destroy();layer=null}_layers=null}if(_lastLayers){while(_lastLayers.length>0){var layer=_lastLayers.pop();layer.Destroy();layer=null}_lastLayers=null}_id=null;_inited=null;_imageFormat=null;_isNeedTitle=null;_isShowInCurrentPage=null;_legendUrl=null;if(_eventsList){while(_eventsList.length>0){_eventsList.pop()}_eventsList=null}if(_eventsNameList){while(_eventsNameList.length>0){_eventsNameList.pop()}_eventsNameList=null}if(_indexs){while(_indexs.length>0){_indexs.pop()}_indexs=null}_headerBackColor=null;_self.titleFont.Destroy();_self.titleFont=null;_headerForeColor=null;_itemBackColor=null;_self.itemFont.Destroy();_self.itemFont=null;_itemForeColor=null;if(container){container.innerHTML=""}_self=null;container=null}function _InitIndexs(){if(_indexs==null){_indexs=new Array()}for(var i=0;_layers&&i<_layers.length;i++){_indexs[i]=i}}function _RenderLayers(){var url;var innerHTML="";innerHTML+="<table>";if(_isNeedTitle){innerHTML+="<tr style='background-color:"+_headerBackColor+";color:"+_headerForeColor+";font-family:"+_self.titleFont.fontFamily.name+";font-size:"+_self.titleFont.size+";";if(_self.titleFont.bold){innerHTML+="font-weight:bold;"}if(_self.titleFont.italic){innerHTML+="font-style:itlic;"}if(_self.titleFont.underline&&_self.titleFont.strikeout){innerHTML+="text-decoration:underline line-through;"}else{if(_self.titleFont.underline){innerHTML+="text-decoration:underline;"}else{if(_self.titleFont.strikeout){innerHTML+="text-decoration:line-through;"}}}innerHTML+="'>";innerHTML+="<td ColSpan=4 align=center valign=middle>"+SuperMap.IS.LegendControlResource.title+" ("+map.mapName+")</td>";innerHTML+="</tr>"}var trString="";var tdString="";innerHTML+=trString;var resourcesParam=new SuperMap.IS.ResourceParam();resourcesParam.width=_resourceWidth;resourcesParam.height=_resourceHeight;for(var i=0;i<_indexs.length;i++){var m=_indexs[i];if(!_layers[m]){continue}var innerHTMLForEachLayer="";var resourceType="";switch(_layers[m].type){case SuperMap.IS.LayerType.point:resourceType=0;break;case SuperMap.IS.LayerType.line:resourceType=1;break;case SuperMap.IS.LayerType.polygon:resourceType=2;break;case SuperMap.IS.LayerType.grid:resourceType=2;break;default:break}var themeImgID=_layers[m].name+"_StyleIMG";resourcesParam.style=_layers[m].style;resourcesParam.resourceType=resourceType;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer="<tr style='background-color:"+_itemBackColor+";color:"+_itemForeColor+";font-family:"+_self.itemFont.fontFamily.name+";font-size:"+_self.itemFont.size+";";if(_self.itemFont.bold){innerHTMLForEachLayer+="font-weight:bold;"}if(_self.itemFont.italic){innerHTMLForEachLayer+="font-style:itlic;"}if(_self.itemFont.underline&&_self.itemFont.strikeout){innerHTMLForEachLayer+="text-decoration:underline line-through;"}else{if(_self.itemFont.underline){innerHTMLForEachLayer+="text-decoration:underline;"}else{if(_self.itemFont.strikeout){innerHTMLForEachLayer+="text-decoration:line-through;"}}}innerHTMLForEachLayer+="'>";var bHasTheme=false;if(_layers[m].themeUnique||_layers[m].themeRange||_layers[m].themeGraph||_layers[m].themeGraduatedSymbol||_layers[m].themeLabel||_layers[m].themeDotDensity||_layers[m].themeGridRange||_layers[m].themeCustom){bHasTheme=true}innerHTMLForEachLayer+='<td valign="top" width="20px">';if(bHasTheme){if(_self.expand){innerHTMLForEachLayer+='<img id="Switch_'+_id+"_"+_layers[m].name+'_Themes" src="images/expand.gif" >'}else{innerHTMLForEachLayer+='<img id="Switch_'+_id+"_"+_layers[m].name+'_Themes" src="images/collapse.gif" >'}}innerHTMLForEachLayer+="</td><td>";if(_layers[m].type==SuperMap.IS.LayerType.point||_layers[m].type==SuperMap.IS.LayerType.line||_layers[m].type==SuperMap.IS.LayerType.polygon){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="'+map.GenerateResourceRequest(resourcesParam)+'" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.network){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/Network.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.text){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/Text.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.image){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/Image.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.mrSID){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/MRSID.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.grid){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/GRID.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.dem){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/Dem.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.ecw){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/Ecw.gif" >'}else{if(_layers[m].type==SuperMap.IS.LayerType.cad){innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/CAD.gif" >'}else{innerHTMLForEachLayer+='<img id="'+themeImgID+'"  width='+_resourceWidth+" height="+_resourceHeight+' src="images/spacer.gif" >'}}}}}}}}}innerHTMLForEachLayer+='<span style="font-weight:bold">'+_layers[m].caption.split(_self.separator)[0]+"</span>";if(_self.expand){innerHTMLForEachLayer+='<table id="'+_id+"_"+_layers[m].name+'_Themes" style="display:block">'}else{innerHTMLForEachLayer+='<table id="'+_id+"_"+_layers[m].name+'_Themes" style="display:none">'}var uniqueTheme=_layers[m].themeUnique;if(uniqueTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"Unique",uniqueTheme);var imgID=_layers[m].name+"_ThemeUnique_IMG";for(var j=0;j<uniqueTheme.values.length;j++){resourcesParam.style=uniqueTheme.displays[j];resourcesParam.resourceType=resourceType;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer+='<div><img id="'+imgID+'"src="'+map.GenerateResourceRequest(resourcesParam)+'">'+uniqueTheme.itemCaptions[j]+"</div>"}innerHTMLForEachLayer+=WriteEndScriptPart()}var rangeTheme=_layers[m].themeRange;if(rangeTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"Range",rangeTheme);for(var j=0;j<rangeTheme.displays.length;j++){var imgID=_layers[m].name+"_ThemeRange_IMG"+j;resourcesParam.style=rangeTheme.displays[j];resourcesParam.resourceType=resourceType;resourcesParam.imageFormat=_imageFormat;var value="";if(j==0){value="x<"+rangeTheme.breakValues[j]}else{if(j==rangeTheme.displays.length-1){value=rangeTheme.breakValues[j-1]+"<=x"}else{value=rangeTheme.breakValues[j-1]+"<=x<"+rangeTheme.breakValues[j]}}innerHTMLForEachLayer+='<div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+value+"</div>"}innerHTMLForEachLayer+=WriteEndScriptPart()}var graphTheme=_layers[m].themeGraph;if(graphTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"Graph",graphTheme);for(var j=0;j<graphTheme.graphStyles.length;j++){var imgID=_layers[m].name+"_ThemeGraph_IMG"+j;resourcesParam.style=graphTheme.graphStyles[j];resourcesParam.resourceType=2;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer+='<div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+graphTheme.expressions[j]+"</div>"}innerHTMLForEachLayer+=WriteEndScriptPart()}var graduatedSymbolTheme=_layers[m].themeGraduatedSymbol;if(graduatedSymbolTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"GraduatedSymbol",graduatedSymbolTheme);var imgID;imgID=_layers[m].name+"_ThemeGraph_IMG_0";resourcesParam.style=graduatedSymbolTheme.styleForPositive;resourcesParam.resourceType=0;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer+='<Div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+SuperMap.IS.LegendControlResource.positive+"</div>";if(graduatedSymbolTheme.showNegative==true){imgID=_layers[m].name+"_ThemeGraph_IMG_1";resourcesParam.style=graduatedSymbolTheme.styleForNegative;resourcesParam.resourceType=0;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer+='<Div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+SuperMap.IS.LegendControlResource.negative+"</div>";innerHTMLForEachLayer+=WriteEndScriptPart()}}var labelTheme=_layers[m].themeLabel;if(labelTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"Label",labelTheme);innerHTMLForEachLayer+=WriteEndScriptPart()}var dotDemsityTheme=_layers[m].themeDotDensity;if(dotDemsityTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"DotDensity",dotDemsityTheme);var imgID=_layers[m].name+"_ThemeDotDensity_IMG";resourcesParam.style=dotDemsityTheme.dotStyle;resourcesParam.resourceType=0;resourcesParam.imageFormat=_imageFormat;innerHTMLForEachLayer+='<div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+dotDemsityTheme.dotValue+"</div>";innerHTMLForEachLayer+=WriteEndScriptPart()}var gridRangeTheme=_layers[m].themeGridRange;if(gridRangeTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"GridRange",gridRangeTheme);for(var j=0;j<gridRangeTheme.displays.length;j++){var imgID=_layers[m].name+"_ThemeRange_IMG"+j;resourcesParam.style=new SuperMap.IS.Style();resourcesParam.style.brushColor=gridRangeTheme.displays[j];resourcesParam.resourceType=resourceType;resourcesParam.imageFormat=_imageFormat;var value="";if(gridRangeTheme.breakValues[0]==null){continue}if(j==0){value="x< "+gridRangeTheme.breakValues[j]}else{if(j==gridRangeTheme.displays.length-1){value=gridRangeTheme.breakValues[j-1]+"<=x"}else{value=gridRangeTheme.breakValues[j-1]+"<=x<"+gridRangeTheme.breakValues[j]}}innerHTMLForEachLayer+='<div><img id="'+imgID+'" src="'+map.GenerateResourceRequest(resourcesParam)+'" >'+value+"</div>"}innerHTMLForEachLayer+=WriteEndScriptPart()}var customTheme=_layers[m].themeCustom;if(customTheme!=null){innerHTMLForEachLayer+=WriteStartScriptPart(m,"Custom",customTheme);innerHTMLForEachLayer+=WriteEndScriptPart()}innerHTMLForEachLayer+="</table></td>";innerHTMLForEachLayer+="</tr>";innerHTML+=innerHTMLForEachLayer}innerHTML+=trString;innerHTML+="</table>";var form=document.createElement("form");form.innerHTML=innerHTML;_containerInside.appendChild(form);for(var i=0;i<_indexs.length;i++){var m=_indexs[i];if(!_layers[m]){continue}var bHasTheme=false;if(_layers[m].themeUnique||_layers[m].themeRange||_layers[m].themeGraph||_layers[m].themeGraduatedSymbol||_layers[m].themeLabel||_layers[m].themeDotDensity||_layers[m].themeGridRange||_layers[m].themeCustom){bHasTheme=true}if(bHasTheme){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_Themes",function(e){_SwitchThemesDisplay(e)})}var uniqueTheme=_layers[m].themeUnique;if(uniqueTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_Unique",function(e){_SwitchThemesDisplay(e)})}var rangeTheme=_layers[m].themeRange;if(rangeTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_Range",function(e){_SwitchThemesDisplay(e)})}var graphTheme=_layers[m].themeGraph;if(graphTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_Graph",function(e){_SwitchThemesDisplay(e)})}var graduatedSymbolTheme=_layers[m].themeGraduatedSymbol;if(graduatedSymbolTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_GraduatedSymbol",function(e){_SwitchThemesDisplay(e)})}var labelTheme=_layers[m].themeLabel;if(labelTheme!=null){}var dotDemsityTheme=_layers[m].themeDotDensity;if(dotDemsityTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_DotDensity",function(e){_SwitchThemesDisplay(e)})}var gridRangeTheme=_layers[m].themeGridRange;if(gridRangeTheme!=null){_JudgeMethod("Switch_"+_id+"_"+_layers[m].name+"_GridRange",function(e){_SwitchThemesDisplay(e)})}var customTheme=_layers[m].themeCustom;if(customTheme!=null){}}if(_lastLayers==null){_lastLayers=new Array()}for(var i=0;_layers&&i<_layers.length;i++){if(_lastLayers[i]==null){_lastLayers[i]=new SuperMap.IS.Layer()}_lastLayers[i].Copy(_layers[i])}}function _JudgeMethod(id,method){var inputbox=document.getElementById(id);if(inputbox!=null){if(_ygPos.browser=="ie"){inputbox.attachEvent("onclick",method)}else{inputbox.addEventListener("click",method,true)}inputbox=null}}function WriteStartScriptPart(index,themeType,theme){var str="<tr>";str+='<td valign="top" width="20px">';if(themeType!="Label"&&themeType!="Custom"){str+='<img id="Switch_'+_id+"_"+_layers[index].name+"_"+themeType+'"  src="images/expand.gif" >'}var themeName="";if(theme!=null){themeName=theme.caption}var picName="";switch(themeType){case"DotDensity":picName="ThemeDotDensity.gif";break;case"GraduatedSymbol":picName="ThemeGraduatedSymbol.gif";break;case"Graph":picName="ThemeGraph.gif";break;case"Label":picName="ThemeLabel.gif";break;case"Range":picName="ThemeRange.gif";break;case"Unique":picName="ThemeUnique.gif";break;case"Custom":picName="ThemeCustom.gif";break;case"GridRange":picName="ThemeRange.gif";if(theme.breakValues[0]==null){str='<tr><td valign="top" width="20px">'}break}str+='</td><td><table><tr><td valign="top" width="20px"> <img src="images/'+picName+'"> </td><td>';if(_themeNameEnabled==true){str+=themeName}str+="</td><tr><td></td><td>";str+='<div id="'+_id+"_"+_layers[index].name+"_"+themeType+'" style="display:block">';return str}function WriteEndScriptPart(){var str="</div></td></tr></table></td></tr>";return str}function onGetResourceComplete(url,userContext){var img=document.getElementById(userContext);img.src=url}function onGetResourceError(){}this.SwitchThemesDisplay=_SwitchThemesDisplay;function _SwitchThemesDisplay(e){var strId=e.srcElement.id;var strNew=strId.replace("Switch_","");var img=document.getElementById(strId);var o=document.getElementById(strNew);if(o==null||img==null){return }if(o.style.display=="block"){o.style.display="none";img.src="images/collapse.gif"}else{o.style.display="block";img.src="images/expand.gif"}}function _Update(){_inited=false;_Init()}}
