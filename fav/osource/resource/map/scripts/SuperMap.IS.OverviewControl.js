//================================================================================ 
// SuperMap IS .NET 客户端程序，版权所有，北京超图软件股份有限公司，2000-2008。 
// 本程序只能在有效的授权许可下使用。未经许可，不得以任何手段擅自使用或传播。 
// 作 者:  SuperMap IS Web Team 
// 版 本:  $Id: SuperMap.IS.OverviewControl.js,v 1.37.2.16 2009/11/09 06:59:03 zhangyt Exp $
// 文 件:  SuperMap.IS.OverviewControl.js 
// 描 述:  AjaxScripts 鹰眼控件 
// 更 新:  $Date: 2009/11/09 06:59:03 $ 
//================================================================================ 
SuperMap.IS.OverviewControl=function(container,mapControl,params){
	if(!mapControl||!container){return }
	var _mapControl=mapControl;
	var _viewBounds=null;
	var _indexBounds=null;
	var _overviewUrl="";
	var _eventsList=new Array();
	var _eventsNameList=new Array();
	var _indexBox=null;
	var _mapName="";
	var _containerInside=null;
	var _width=container.clientWidth;
	var _height=container.clientHeight;
	var _left=0,_top=0;
	var _borderWidth=2;
	var _leftForIndexBox=0,_topForIndexBox=0;
	var _widthForIndexBox=0,_heightForIndexBox=0;
	var _originX=0,_originY=0;
	var _offsetX=0,_offsetY=0;
	var _bMouseDown;
	var _initing=false;
	var _inited=false;
	var _switchMap=false;
	var _triggeredEvent=false;
	var _url;
	var overviewresize="none";
	var _originWidth=0,_originHeight=0;
	var range=5;
	var _indexBoxBorderColor="red";
	var _indexBoxBorderStyle="solid";
	var _indexBoxBorderWidth="2px";
	var _overviewLayer=null,_overviewImage=null;
	_mapControl.AttachEvent("oninit",_OnMapInit);
	this.url;
	this.viewBounds;
	this.mapName;
	this.Destroy=_Destroy;
	this.AttachEvent=_AttachEvent;
	this.DetachEvent=_DetachEvent;
	var _self=this;
	this.Show=function(){container.style.visibility="visible";
	_indexBox.style.visibility="visible"};
	this.Hide=function(){container.style.visibility="hidden";
	_indexBox.style.visibility="hidden"};
	function _OnMapInit(){_Init();
	console.log("_OnMapInit")}function _OnMapChangeView(){console.log("_OnMapChangeView");
if(_switchMap){_switchMap=false;
return }if(!_triggeredEvent){_originX=parseInt(_indexBox.style.left);
_originY=parseInt(_indexBox.style.top)}_indexBounds=_mapControl.GetViewBounds();
console.log("_indexBounds:"+_indexBounds.ToString());
_ComputeIndexBox();
_DrawIndexBox(true);
_triggeredEvent=false}function _OnMapSwitchMap(){console.log("_OnMapSwitchMap");
_mapName="";
_viewBounds=null;
params=null;
_SwitchMap()}function _OnMapDestroy(){console.log("_OnMapDestroy");
_Destroy()}function _Init(){if(_initing||_inited){return }_initing=true;
if(params){if(params.indexBoxBorderColor){_indexBoxBorderColor=params.indexBoxBorderColor}if(params.indexBoxBorderStyle){_indexBoxBorderStyle=params.indexBoxBorderStyle}if(params.indexBoxBorderWidth){_indexBoxBorderWidth=params.indexBoxBorderWidth}if(params.mapName){_mapName=params.mapName}if(params.viewBounds){_viewBounds=params.viewBounds}if(params.overviewUrl){_self.url=params.overviewUrl}}if(_containerInside&&_containerInside.parentNode){_containerInside.parentNode.removeChild(_containerInside)}if(!_containerInside){_containerInside=document.createElement("div")}var es=null;
es=_containerInside.style;
es.width=_width+"px";
es.height=_height+"px";
es.position="relative";
es.overflow="hidden";
container.appendChild(_containerInside);
if(_indexBox&&_indexBox.parentNode){_indexBox.parentNode.removeChild(_indexBox)}if(!_indexBox){_indexBox=document.createElement("div")}_indexBox.id=container.id+"_IndexBox";
es=_indexBox.style;
es.borderColor=_indexBoxBorderColor;
es.borderStyle=_indexBoxBorderStyle;
es.borderWidth=_indexBoxBorderWidth;
es.position="absolute";
es.visibility="visible";
es.zIndex=1;
es.fontSize="1px";
es.width=_widthForIndexBox+"px";
es.height=_heightForIndexBox+"px";
es.left=_leftForIndexBox+"px";
es.top=_topForIndexBox+"px";
es=null;
_containerInside.appendChild(_indexBox);
_mapControl.AttachEvent("onstartswitchmap",_OnStartSwitchMap);
_mapControl.AttachEvent("onchangeview",_OnMapChangeView);
_mapControl.AttachEvent("onendswitchmap",_OnMapSwitchMap);
_mapControl.AttachEvent("ondestroying",_OnMapDestroy);
container.attachEvent("onmousedown",_OnMouseDown);
container.attachEvent("onmousemove",_OnMouseMove);
container.attachEvent("onmouseup",_OnMouseUp);
container.attachEvent("onmouseover",_OnMouseOver);
container.attachEvent("onmousewheel",_OnMouseWheel);
_SwitchMap();
_inited=true}function _OnStartSwitchMap(){_switchMap=true}function _Destroy(){_mapControl.DetachEvent("oninit",_OnMapInit);
_mapControl.DetachEvent("onstartswitchmap",_OnStartSwitchMap);
_mapControl.DetachEvent("onchangeview",_OnMapChangeView);
_mapControl.DetachEvent("onendswitchmap",_OnMapSwitchMap);
_mapControl.DetachEvent("ondestroying",_OnMapDestroy);
_mapControl=null;
if(_indexBox&&_indexBox.parentNode){_indexBox.parentNode.removeChild(_indexBox)}_indexBox=null;
if(_containerInside&&_containerInside.parentNode){_containerInside.parentNode.removeChild(_containerInside)}_containerInside=null;
_viewBounds=null;
_indexBounds=null;
container.detachEvent("onmousedown",_OnMouseDown);
container.detachEvent("onmousemove",_OnMouseMove);
container.detachEvent("onmouseup",_OnMouseUp);
container.detachEvent("onmouseover",_OnMouseOver);
container.detachEvent("onmousewheel",_OnMouseWheel);
container=params=null}function _SwitchMap(){if(!_mapName){_mapName=_mapControl.mapName}if(!_viewBounds){_viewBounds=_mapControl.GetMapBounds()}console.log("_viewBounds:"+_viewBounds.ToString());
_indexBounds=_mapControl.GetViewBounds();
console.log("_indexBounds:"+_indexBounds.ToString());
_ComputeIndexBox();
_DrawIndexBox(true);
_GetOverview()}function _GetOverview(){if(!_self.url){var overview=new SuperMap.IS.Overview();
overview.mapName=_mapName;
overview.viewer=new SuperMap.IS.PixelRect(0,0,_width,_height);
overview.viewBounds=_viewBounds;
_mapControl.GetOverview(overview,_OnGetOverviewComplete,_OnGetOverviewError,"_SwitchMap")}else{this.viewBounds=_viewBounds;
_containerInside.style.backgroundImage="url("+_self.url+")";
_containerInside.style.backgroundRepeat="no-repeat"}}function _AttachEvent(event,listener){var events=_eventsList[event];
if(!events){events=new Array();
_eventsList[event]=events;
_eventsNameList.push(event)}for(var i=0;
i<events.length;
i++){if(events[i]==listener){return true}}events.push(listener)}function _DetachEvent(event,listener){var events=_eventsList[event];
if(!events){return }for(var i=0;
i<events.length;
i++){if(events[i]==listener){events.splice(i,1)}}}function _TriggerEvent(event,arguments,userContext){var events=_eventsList[event];
if(!events){return }if(!arguments){arguments=_GenerateEventArg()}var eventsTemp=events.concat();
for(var i=0;
i<eventsTemp.length;
i++){if(eventsTemp[i]){eventsTemp[i](arguments,userContext)}}while(eventsTemp.length>0){eventsTemp.pop()}}function _GenerateEventArg(){var _offsetX=parseInt(_indexBox.style.left)-parseInt(_originX);
var _offsetY=parseInt(_indexBox.style.top)-parseInt(_originY);
var mapSize=_mapControl.GetSize();
var ratioX=mapSize.Width()/_indexBox.realWidth;
var ratioY=mapSize.Height()/_indexBox.realHeight;
_offsetX=_offsetX*ratioX;
_offsetY=_offsetY*ratioY;
var arguments=new Object();
arguments.offsetX=_offsetX;
arguments.offsetY=_offsetX;
return arguments}this.TriggerServerEvent=function(eventName,e){_eval(container.id+"_doPostBack(container.id, eventName+'|'+e.offsetX+','+e.offsetY)")};
function _DrawIndexBox(trigger){var es=_indexBox.style;
es.width=_widthForIndexBox+"px";
es.height=_heightForIndexBox+"px";
es.left=_leftForIndexBox+"px";
es.top=_topForIndexBox+"px";
es=null;
_indexBox.parentNode.removeChild(_indexBox);
_containerInside.appendChild(_indexBox);
if(!_triggeredEvent&&trigger){_offsetX=parseInt(_indexBox.style.left)-parseInt(_originX);
_offsetY=parseInt(_indexBox.style.top)-parseInt(_originY);
if(_offsetX==0||_offsetY==0){return }var mapSize=_mapControl.GetSize();
var ratioX=mapSize.Width()/_indexBox.realWidth;
var ratioY=mapSize.Height()/_indexBox.realHeight;
_offsetX=_offsetX*ratioX;
_offsetY=_offsetY*ratioY;
_triggeredEvent=true;
_TriggerEvent("indexboxChanged",{offsetX:_offsetX,offsetY:_offsetX},"IndexboxChanged")}_SetPropertyHidden()}function _SetPropertyHidden(){var o=new Object();
o.viewBounds=_viewBounds;
o.indexBounds=_indexBounds;
var propertyJSON=_ToJSON(o);
var hidden=document.getElementById(container.id+"_hiddenProperty");
if(hidden){hidden.value=propertyJSON}}function _ComputeIndexBox(){var leftRatio=(_indexBounds.leftBottom.x-_viewBounds.leftBottom.x)/(_viewBounds.rightTop.x-_viewBounds.leftBottom.x);
_leftForIndexBox=_width*leftRatio;
var topRatio=(_viewBounds.rightTop.y-_indexBounds.rightTop.y)/(_viewBounds.rightTop.y-_viewBounds.leftBottom.y);
_topForIndexBox=_height*topRatio;
var widthRatio=(_indexBounds.rightTop.x-_indexBounds.leftBottom.x)/(_viewBounds.rightTop.x-_viewBounds.leftBottom.x);
_widthForIndexBox=_width*widthRatio;
_indexBox.realWidth=_widthForIndexBox;
var heightRatio=(_indexBounds.rightTop.y-_indexBounds.leftBottom.y)/(_viewBounds.rightTop.y-_viewBounds.leftBottom.y);
_heightForIndexBox=_height*heightRatio;
_indexBox.realHeight=_heightForIndexBox;
if(_viewBounds.leftBottom.x<=mapControl.GetMapBounds().leftBottom.x||_viewBounds.leftBottom.y<=mapControl.GetMapBounds().leftBottom.y||_viewBounds.rightTop.x>=mapControl.GetMapBounds().rightTop.x||_viewBounds.rightTop.y>=mapControl.GetMapBounds().rightTop.y){if(_leftForIndexBox<0){_widthForIndexBox=_widthForIndexBox+_leftForIndexBox;
_leftForIndexBox=0}if(_leftForIndexBox+_widthForIndexBox>_width-2*_borderWidth){_widthForIndexBox=_width-2*_borderWidth-_leftForIndexBox}if(_topForIndexBox<0){_heightForIndexBox=_heightForIndexBox+_topForIndexBox;
_topForIndexBox=0}if(_topForIndexBox+_heightForIndexBox>_height-2*_borderWidth){_heightForIndexBox=_height-2*_borderWidth-_topForIndexBox}if(_widthForIndexBox<5){_widthForIndexBox=5}if(_heightForIndexBox<5){_heightForIndexBox=5}if(_widthForIndexBox>_width){_widthForIndexBox=_width}if(_heightForIndexBox>_height){_heightForIndexBox=_height}}}function _OnMouseOver(e){if(_widthForIndexBox>range&&_heightForIndexBox>range){e=_GetEvent(e);
var mouseX=_GetMouseX(e);
var mouseY=_GetMouseY(e);
changeCursor(mouseX,mouseY)}}function _OnMouseDown(e){_bMouseDown=true;
_CancelBubble(e);
_originX=_leftForIndexBox;
_originY=_topForIndexBox;
_originWidth=_indexBox.realWidth;
_originHeight=_indexBox.realHeight;
_left=_GetElementX(container);
_top=_GetElementY(container);
e=_GetEvent(e);
var mouseX=_GetMouseX(e);
var mouseY=_GetMouseY(e);
if(_widthForIndexBox>range&&_heightForIndexBox>range){var indexBoxLeft=_left+_originX;
var indexBoxTop=_top+_originY;
var indexBoxRight=indexBoxLeft+_widthForIndexBox;
var indexBoxBottom=indexBoxTop+_heightForIndexBox;
if(mouseX>=indexBoxLeft-range&&mouseX<=indexBoxLeft+range&&mouseY>=indexBoxTop-range&&mouseY<=indexBoxTop+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nwse.cur"}else{container.style.cursor="nw_resize"}overviewresize="lt";
_originX=_originX+_originWidth;
_originY=_originY+_originHeight}if(mouseX>=indexBoxLeft-range&&mouseX<=indexBoxLeft+range&&mouseY>=indexBoxBottom-range&&mouseY<=indexBoxBottom+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nesw.cur"}else{container.style.cursor="sw_resize"}overviewresize="lb";
_originX=_originX+_originWidth}if(mouseX>=indexBoxRight-range&&mouseX<=indexBoxRight+range&&mouseY>=indexBoxBottom-range&&mouseY<=indexBoxBottom+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nwse.cur"}else{container.style.cursor="se_resize"}overviewresize="rb"}if(mouseX>=indexBoxRight-range&&mouseX<=indexBoxRight+range&&mouseY>=indexBoxTop-range&&mouseY<=indexBoxTop+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nesw.cur"}else{container.style.cursor="ne_resize"}overviewresize="rt";
_originY=_originY+_originHeight}}if(overviewresize=="none"){_leftForIndexBox=mouseX-_left-_widthForIndexBox/2;
_topForIndexBox=mouseY-_top-_heightForIndexBox/2;
_DrawIndexBox(false)}}function _OnMouseMove(e){e=_GetEvent(e);
_CancelBubble(e);
var mouseX=_GetMouseX(e);
var mouseY=_GetMouseY(e);
if(!_bMouseDown){changeCursor(mouseX,mouseY);
return }_left=_GetElementX(_containerInside);
_top=_GetElementY(_containerInside);
if(overviewresize=="lt"||overviewresize=="lb"||overviewresize=="rb"||overviewresize=="rt"){var originWH=_originWidth/_originHeight;
var offsetX=mouseX-_originX;
var offsetY=mouseY-_originY;
_widthForIndexBox=Math.abs(offsetX-_left);
_heightForIndexBox=Math.abs(offsetY-_top);
if(offsetX<_left){_leftForIndexBox=_originX-_widthForIndexBox}else{_leftForIndexBox=_originX}if(offsetY<_top){_topForIndexBox=_originY-_heightForIndexBox}else{_topForIndexBox=_originY}changeCursor(mouseX,mouseY);
_DrawIndexBox(false);
return }else{if(_ygPos.browser=="ie"){container.style.cursor=""}else{container.style.cursor="default"}_leftForIndexBox=mouseX-_left-_widthForIndexBox/2;
_topForIndexBox=mouseY-_top-_heightForIndexBox/2;
_DrawIndexBox(false);
return false}}function _OnMouseUp(e){if(!_bMouseDown){return }_bMouseDown=false;
e=_GetEvent(e);
_CancelBubble(e);
var mapSize=_mapControl.GetSize();
var ratioX=mapSize.Width()/_indexBox.realWidth;
var ratioY=mapSize.Height()/_indexBox.realHeight;
var centerX=_mapControl.GetMapCenterX();
var centerY=_mapControl.GetMapCenterY();
var ms=_mapControl.GetMapScale();
if(overviewresize=="lt"||overviewresize=="lb"||overviewresize=="rb"||overviewresize=="rt"){var mouseX=_GetMouseX(e);
var mouseY=_GetMouseY(e);
changeCursor(mouseX,mouseY);
var ratioWidth=_widthForIndexBox/_originWidth;
_offsetX=_widthForIndexBox-_originWidth;
_offsetY=_heightForIndexBox-_originHeight;
_offsetX=_offsetX*ratioX;
_offsetY=_offsetY*ratioY;
var distanceH=0;
var distanceW=0;
var signX=1;
var signY=1;
var signW=1;
var signH=1;
var distanceX=_mapControl.PixelToMapDistance(_offsetX,ms);
var distanceY=_mapControl.PixelToMapDistance(-_offsetY,ms);
if(_leftForIndexBox<_originX){if(overviewresize=="rb"||overviewresize=="rt"){distanceW=_mapControl.PixelToMapDistance(_originWidth*ratioX,ms);
signW=-1}signX=-1}else{if(overviewresize=="lt"||overviewresize=="lb"){distanceW=_mapControl.PixelToMapDistance(_originWidth*ratioX,ms)}}if(_topForIndexBox<_originY){if(overviewresize=="rb"||overviewresize=="lb"){distanceH=_mapControl.PixelToMapDistance(_originHeight*ratioY,ms)}signY=-1}else{if(overviewresize=="lt"||overviewresize=="rt"){distanceH=_mapControl.PixelToMapDistance(_originHeight*ratioY,ms);
signH=-1}}var position=new SuperMap.IS.MapCoord(centerX+distanceW*signW+distanceX/2*signX,centerY+distanceH*signH+distanceY/2*signY);
if(_mapControl.customBounds!=null){if(!_IsInCustomBounds(position,_mapControl.customBounds,ms/ratioWidth)){_OnMapChangeView();
return }}_mapControl.SetCenterAndZoom(centerX+distanceW*signW+distanceX/2*signX,centerY+distanceH*signH+distanceY/2*signY,ms/ratioWidth);
overviewresize="none"}else{_offsetX=_leftForIndexBox-_originX;
_offsetY=_topForIndexBox-_originY;
_offsetX=_offsetX*ratioX;
_offsetY=_offsetY*ratioY;
var distanceX=_mapControl.PixelToMapDistance(_offsetX,ms);
var distanceY=_mapControl.PixelToMapDistance(-_offsetY,ms);
var position=new SuperMap.IS.MapCoord(centerX+distanceX,centerY+distanceY);
if(_mapControl.customBounds!=null){if(!_IsInCustomBounds(position,_mapControl.customBounds,ms)){_OnMapChangeView();
return }}_mapControl.SetCenterAndZoom(centerX+distanceX,centerY+distanceY)}_DrawIndexBox(true);
_offsetX=0;
_offsetY=0;
return false}function _OnMouseWheel(e){e=_GetEvent(e);
_CancelBubble(e);
if(e.detail){if(e.detail>0){_mapControl.ZoomOut()}else{_mapControl.ZoomIn()}}else{if(e.wheelDelta>0){_mapControl.ZoomIn()}else{_mapControl.ZoomOut()}}if(e.preventDefault){e.preventDefault()}return false}function _OnGetOverviewComplete(overview,userContext){if(!_self.url){this.url=overview.url}else{this.url=_self.url}this.viewBounds=overview.viewBounds;
_containerInside.style.backgroundImage="url("+this.url+")";
_containerInside.style.backgroundRepeat="no-repeat";
if(!_viewBounds||!_viewBounds.Equals(overview.viewBounds)){console.log("_viewBoundsChanged:"+_viewBounds.ToString());
_viewBounds=overview.viewBounds;
_OnMapChangeView()}console.log("_viewBounds:"+_viewBounds.ToString())}function _OnGetOverviewError(responseText){if(responseText){alert(SuperMap.IS.OverivewControlResource.getOverivewError+":"+responseText)}else{alert(SuperMap.IS.OverivewControlResource.getOverivewError+"!")}}this.Update=function(){if(this.viewBounds){_viewBounds=this.viewBounds}else{if(params&&params.viewBounds){_viewBounds=params.viewBounds}else{_viewBounds=_mapControl.GetMapBounds()}}if(this.mapName){_mapName=this.mapName}else{if(params&&params.mapName){_mapName=params.mapName}else{_mapName=_mapControl.mapName}}_GetOverview()};
function changeCursor(eX,eY){_left=_GetElementX(container);
_top=_GetElementY(container);
var indexBoxLeft=_left+_leftForIndexBox;
var indexBoxTop=_top+_topForIndexBox;
var indexBoxRight=indexBoxLeft+_widthForIndexBox;
var indexBoxBottom=indexBoxTop+_heightForIndexBox;
if(eX>=indexBoxLeft-range&&eX<=indexBoxLeft+range&&eY>=indexBoxTop-range&&eY<=indexBoxTop+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nwse.cur"}else{container.style.cursor="nwse-resize"}}else{if(eX>=indexBoxLeft-range&&eX<=indexBoxLeft+range&&eY>=indexBoxBottom-range&&eY<=indexBoxBottom+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nesw.cur"}else{container.style.cursor="nesw-resize"}}else{if(eX>=indexBoxRight-range&&eX<=indexBoxRight+range&&eY>=indexBoxBottom-range&&eY<=indexBoxBottom+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nwse.cur"}else{container.style.cursor="nwse-resize"}}else{if(eX>=indexBoxRight-range&&eX<=indexBoxRight+range&&eY>=indexBoxTop-range&&eY<=indexBoxTop+range){if(_ygPos.browser=="ie"){container.style.cursor=_scriptLocation+"../images/cur_aero_nesw.cur"}else{container.style.cursor="nesw-resize"}}else{if(_ygPos.browser=="ie"){container.style.cursor=""}else{container.style.cursor="default"}}}}}}function _IsInCustomBounds(position,bounds,mapScale){var curMapHeight=0;
var curMapWidth=0;
var boundsRightTopX=0;
var boundsRightTopY=0;
var boundsLeftBottomX=0;
var boundsLeftBottomY=0;
var right=true;
if(mapScale!=null){curMapHeight=mapControl.PixelToMapDistance(mapControl.container.style.pixelHeight,mapScale);
curMapWidth=mapControl.PixelToMapDistance(mapControl.container.style.pixelWidth,mapScale)}boundsRightTopX=bounds.rightTop.x-curMapWidth/2;
boundsRightTopY=bounds.rightTop.y-curMapHeight/2;
boundsLeftBottomX=curMapWidth/2+bounds.leftBottom.x;
boundsLeftBottomY=curMapHeight/2+bounds.leftBottom.y;
if(position.x<boundsLeftBottomX){right=false}if(position.y<boundsLeftBottomY){right=false}if(position.x>boundsRightTopX){right=false}if(position.y>boundsRightTopY){right=false}return right}}
